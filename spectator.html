<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Race Results</title>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: monospace;
        background-color: skyblue;
        color: white;
        text-align: center;
        padding: 2rem;
      }

      h1 {
        margin-bottom: 2rem;
      }

      table {
        margin: 0 auto;
        border-collapse: collapse;
        width: 90%;
        max-width: 700px;
      }

      th,
      td {
        border: 1px solid white;
        padding: 0.75rem;
      }

      th {
        background-color: gray;
      }

      td {
        background-color: gray;
      }

      .exit-button {
        position: fixed;
        top: 20px;
        left: 20px;
        text-decoration: none;
        color: white;
        font-size: 24px;
      }

      .exit-button:hover {
        color: #ccc;
      }

      #export-pdf-btn {
        background-color: lightgray;
        color: black;
        font-weight: bold;
        padding: 40px 30px;
        border: none;
        border-radius: 8px;
        font-size: 20px;
        margin-top: 20px;
        cursor: pointer;
        display: inline-block;
      }

      #export-pdf-btn:hover {
        background-color: #ddd;
      }
    </style>
  </head>
  <body>
    <!-- Exit to Landing Page -->
    <a href="landing.html" class="exit-button" title="Back to Landing Page">
      <span class="material-icons">exit_to_app</span>
    </a>

    <h1>Race Results</h1>

    <table>
      <thead>
        <tr>
          <th>Position</th>
          <th>Runner ID</th>
          <th>Time</th>
          <th>Medal</th>
        </tr>
      </thead>
      <tbody class="results-body"></tbody>
    </table>
    <button id="export-pdf-btn">Export as PDF</button>

    <script type="module">
      const tableBody = document.querySelector(".results-body");

      const loadResults = async () => {
        try {
          const res = await fetch("/results");
          const data = await res.json();

          tableBody.replaceChildren();

          if (!data.length) {
            const row = document.createElement("tr");
            const cell = document.createElement("td");
            cell.textContent = "No results found.";
            cell.colSpan = 4;
            row.appendChild(cell);
            tableBody.appendChild(row);
            return;
          }

          data.sort((a, b) => {
            const getMs = (t) => {
              const parts = t.time.split(":").map(Number);
              return (
                ((parts[0] * 60 + parts[1]) * 60 + parts[2]) * 1000 +
                (parts[3] || 0)
              );
            };
            return getMs(a) - getMs(b);
          });

          data.forEach((runner, index) => {
            const row = document.createElement("tr");

            const posCell = document.createElement("td");
            const idCell = document.createElement("td");
            const timeCell = document.createElement("td");
            const medalCell = document.createElement("td");

            if (index === 0) {
              posCell.textContent = "1st";
              medalCell.textContent = "ðŸ¥‡";
            } else if (index === 1) {
              posCell.textContent = "2nd";
              medalCell.textContent = "ðŸ¥ˆ";
            } else if (index === 2) {
              posCell.textContent = "3rd";
              medalCell.textContent = "ðŸ¥‰";
            } else {
              posCell.textContent = `${index + 1}th`;
              medalCell.textContent = "-";
            }

            idCell.textContent = runner.id;
            timeCell.textContent = runner.time;

            row.appendChild(posCell);
            row.appendChild(idCell);
            row.appendChild(timeCell);
            row.appendChild(medalCell);

            tableBody.appendChild(row);
          });
        } catch (err) {
          console.error("Failed to load results:", err);
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.textContent = "Failed to load results.";
          cell.colSpan = 4;
          row.appendChild(cell);
          tableBody.appendChild(row);
        }
      };

      loadResults();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
      document
        .querySelector("#export-pdf-btn")
        .addEventListener("click", () => {
          const element = document.querySelector("table");
          const opt = {
            margin: 0.5,
            filename: "race_results.pdf",
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
          };
          html2pdf().set(opt).from(element).save();
        });
    </script>
  </body>
</html>

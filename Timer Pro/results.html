<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Race Results</title>
    <link rel="icon" type="image/png" href="/icon.png" />
    <style>
      body {
        font-family: monospace;
        background-color: skyblue;
        color: white;
        text-align: center;
        padding: 2rem;
      }

      h1 {
        margin-bottom: 2rem;
      }

      table {
        margin: 0 auto;
        border-collapse: collapse;
        width: 90%;
        max-width: 700px;
      }

      th,
      td {
        border: 1px solid white;
        padding: 0.75rem;
      }

      th {
        background-color: gray;
      }

      td {
        background-color: gray;
      }

      .buttons {
        margin-top: 2rem;
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
      }

      button {
        padding: 1.5rem 2rem;
        font-size: 16px;
        font-weight: bold;
        border: none;
        border-radius: 6px;
        background: #ddd;
        color: black;
        cursor: pointer;
      }

      button:hover {
        background: #ccc;
      }
    </style>
  </head>
  <body>
    <h1>Race Results</h1>

    <table>
      <thead>
        <tr>
          <th>Position</th>
          <th>Runner ID</th>
          <th>Time</th>
          <th>Medal</th>
        </tr>
      </thead>
      <tbody class="results-body"></tbody>
    </table>

    <div class="buttons">
      <button class="refresh-btn">Refresh</button>
      <button class="clear-btn">Clear Server Results</button>
      <button onclick="history.back()">Back to Timer</button>
      <button id="export-btn">Export as CSV</button>
    </div>

    <script type="module">
      const tableBody = document.querySelector(".results-body");
      const refreshBtn = document.querySelector(".refresh-btn");
      const clearBtn = document.querySelector(".clear-btn");

      const loadResults = async () => {
        try {
          const res = await fetch("/results");
          const data = await res.json();

          tableBody.replaceChildren();

          if (!data.length) {
            const row = document.createElement("tr");
            const cell = document.createElement("td");
            cell.textContent = "No results found.";
            cell.colSpan = 4;
            row.appendChild(cell);
            tableBody.appendChild(row);
            return;
          }

          data.sort((a, b) => {
            // Optional: sort by milliseconds if available
            const getMs = (t) => {
              const parts = t.time.split(":").map(Number);
              return (
                ((parts[0] * 60 + parts[1]) * 60 + parts[2]) * 1000 + parts[3]
              );
            };
            return getMs(a) - getMs(b);
          });

          data.forEach((runner, index) => {
            const row = document.createElement("tr");

            const posCell = document.createElement("td");
            const idCell = document.createElement("td");
            const timeCell = document.createElement("td");
            const medalCell = document.createElement("td");

            // Position + medal
            if (index === 0) {
              posCell.textContent = "1st";
              medalCell.textContent = "ðŸ¥‡";
            } else if (index === 1) {
              posCell.textContent = "2nd";
              medalCell.textContent = "ðŸ¥ˆ";
            } else if (index === 2) {
              posCell.textContent = "3rd";
              medalCell.textContent = "ðŸ¥‰";
            } else {
              posCell.textContent = `${index + 1}th`;
              medalCell.textContent = "-";
            }

            idCell.textContent = runner.id;
            timeCell.textContent = runner.time;

            row.appendChild(posCell);
            row.appendChild(idCell);
            row.appendChild(timeCell);
            row.appendChild(medalCell);

            tableBody.appendChild(row);
          });
        } catch (err) {
          console.error("Failed to load results:", err);
        }
      };
      const clearResults = async () => {
        try {
          await fetch("/clear", { method: "DELETE" });
          tableBody.replaceChildren();
          feedbackBox.textContent = "All results cleared.";
        } catch (err) {
          console.error("Failed to clear results:", err);
          feedbackBox.textContent = "Error clearing results.";
        }
      };
      const exportBtn = document.getElementById("export-btn");

      exportBtn.addEventListener("click", async () => {
        try {
          const res = await fetch("/results");
          const data = await res.json();

          if (!data.length) {
            alert("No results to export.");
            return;
          }

          let csvContent = "Position,Runner ID,Time,Medal\n";

          data.sort((a, b) => {
            const getMs = (t) => {
              const parts = t.time.split(":").map(Number);
              return (
                ((parts[0] * 60 + parts[1]) * 60 + parts[2]) * 1000 + parts[3]
              );
            };
            return getMs(a) - getMs(b);
          });

          data.forEach((runner, index) => {
            const position =
              index === 0
                ? "1st"
                : index === 1
                ? "2nd"
                : index === 2
                ? "3rd"
                : `${index + 1}th`;
            const medal =
              index === 0
                ? "ðŸ¥‡"
                : index === 1
                ? "ðŸ¥ˆ"
                : index === 2
                ? "ðŸ¥‰"
                : "-";
            csvContent += `${position},${runner.id},${runner.time},${medal}\n`;
          });

          const blob = new Blob([csvContent], {
            type: "text/csv;charset=utf-8;",
          });
          const url = URL.createObjectURL(blob);

          const link = document.createElement("a");
          link.setAttribute("href", url);
          link.setAttribute("download", "race_results.csv");
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } catch (err) {
          console.error("Export failed:", err);
          alert("Failed to export results.");
        }
      });

      clearBtn.addEventListener("click", clearResults);

      refreshBtn.addEventListener("click", loadResults);
      loadResults();
    </script>
  </body>
</html>
